# 《无限公司 Unlimited Corp.》关键决策文档

## 文档信息
| 项目 | 内容 |
|------|------|
| 文档版本 | v1.0 |
| 文档类型 | 架构决策记录 (ADR) |
| 创建日期 | 2024年10月 |
| 状态 | 待评审 |

---

## 1. AI模型策略

### ADR-001: AI模型接入方案

#### 背景
系统需要调用多种大语言模型执行技能卡，需决定是直接调用各厂商API还是建设统一网关。

#### 决策
**采用「自建AI网关 + 多模型适配层」方案**

#### 理由
1. **统一计费**：所有模型调用通过网关计量，便于Token消耗统计和成本核算
2. **故障隔离**：单一模型API故障时可自动降级到备用模型
3. **厂商中立**：用户可自由选择模型，平台不绑定单一供应商
4. **合规管理**：统一进行内容安全审核和日志记录

#### 技术实现
```
┌────────────────────────────────────────────────────────────────┐
│                       AI Gateway                               │
├────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │  路由层      │  │  计量层      │  │  缓存层      │         │
│  │  (选择模型)  │  │  (Token计数) │  │  (结果缓存)  │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
│                                                                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │  熔断器      │  │  内容审核    │  │  日志记录    │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
├────────────────────────────────────────────────────────────────┤
│                      模型适配层                                 │
│  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐       │
│  │ OpenAI │ │ Claude │ │ 文心   │ │ 通义   │ │ 月之暗面│       │
│  └────────┘ └────────┘ └────────┘ └────────┘ └────────┘       │
└────────────────────────────────────────────────────────────────┘
```

#### 默认模型配置

| 场景 | 主模型 | 备用模型 | 理由 |
|------|--------|----------|------|
| 文本生成 | GPT-4o | Claude-3.5-Sonnet | 综合能力强 |
| 代码生成 | GPT-4o | Claude-3.5-Sonnet | 代码理解好 |
| 图像生成 | DALL-E 3 | Midjourney API | 质量稳定 |
| 内容审核 | 自研模型 | 阿里云内容安全 | 成本可控 |

#### 用户自选模型规则
- **免费版**：仅可使用平台默认模型
- **专业版**：可选择所有已接入模型，自行承担超额Token费用
- **团队版**：可接入企业自有模型API

---

### ADR-002: Token计费策略

#### 背景
需明确AI调用的计费粒度和计费规则。

#### 决策
**采用「任务维度计费 + Token透明展示」方案**

#### 计费规则

| 订阅类型 | 月度Token额度 | 超额价格 |
|----------|---------------|----------|
| 免费版 | 10万 tokens | 不支持超额 |
| 专业版 | 100万 tokens | ¥0.03/千tokens |
| 团队版 | 500万 tokens | ¥0.02/千tokens |

#### Token计算规则
```
任务Token消耗 = Σ (各步骤输入Token + 输出Token) × 模型系数

模型系数：
- GPT-4o: 1.0
- Claude-3.5-Sonnet: 0.9
- GPT-3.5-turbo: 0.3
- 文心一言: 0.5
```

#### 用户可见信息
- 每日Token消耗统计
- 每个任务的Token明细
- 额度预警（达到80%时通知）

---

## 2. 多租户与权限

### ADR-003: 团队版多租户隔离方案

#### 背景
团队版需支持多用户协作，需明确数据隔离和权限控制策略。

#### 决策
**采用「逻辑隔离 + 行级安全」方案**

#### 数据隔离模型
```
┌─────────────────────────────────────────────────────────────────┐
│                        组织 (Organization)                      │
│                     团队版用户所属的顶层实体                      │
├─────────────────────────────────────────────────────────────────┤
│  ┌───────────────────┐  ┌───────────────────┐                  │
│  │  公司A (Company)  │  │  公司B (Company)  │  ← 子公司/部门   │
│  │                   │  │                   │                  │
│  │  ├─ 员工          │  │  ├─ 员工          │                  │
│  │  ├─ 技能卡        │  │  ├─ 技能卡        │                  │
│  │  ├─ 工作流        │  │  ├─ 工作流        │                  │
│  │  └─ 任务          │  │  └─ 任务          │                  │
│  └───────────────────┘  └───────────────────┘                  │
│                                                                 │
│  共享资源池：                                                    │
│  ├─ 组织级技能卡库（标记为组织共享的技能卡）                      │
│  └─ 组织级工作流模板                                             │
└─────────────────────────────────────────────────────────────────┘
```

#### 权限模型 (RBAC)

| 角色 | 层级 | 权限范围 |
|------|------|----------|
| org_owner | 组织 | 组织全部资源，账单管理，成员管理 |
| org_admin | 组织 | 组织资源管理，成员管理（不含账单） |
| company_owner | 公司 | 本公司全部资源，公司成员管理 |
| company_admin | 公司 | 本公司资源管理 |
| member | 公司 | 任务执行与查看，有限的资源创建 |
| viewer | 公司 | 只读访问 |

#### 资源共享规则

| 资源类型 | 共享范围 | 共享方式 |
|----------|----------|----------|
| 技能卡 | 组织内 | 创建者标记为"组织共享" |
| 工作流模板 | 组织内 | 创建者标记为"组织共享" |
| 员工 | 公司内 | 不可跨公司共享 |
| 任务产出物 | 公司内 | 可通过链接分享给组织内其他成员 |

---

### ADR-004: 个人版与团队版数据迁移

#### 背景
个人用户升级到团队版时，历史数据如何处理。

#### 决策
**采用「原地升级 + 数据保留」方案**

#### 迁移规则
1. 个人版公司自动成为组织下的第一个公司
2. 原用户成为 org_owner + company_owner
3. 所有历史数据保留，绑定关系不变
4. 新邀请成员默认为 member 角色

---

## 3. 实时通信

### ADR-005: WebSocket连接管理策略

#### 背景
需支持多端实时同步，需明确连接管理、心跳、重连策略。

#### 决策详情

#### 连接管理
```yaml
连接配置:
  max_connections_per_user: 5          # 单用户最多5个设备同时在线
  connection_timeout: 30s              # 连接超时
  idle_timeout: 300s                   # 空闲超时（无消息交互）
  
心跳机制:
  interval: 30s                        # 心跳间隔
  timeout: 10s                         # 心跳响应超时
  max_missed: 3                        # 最大丢失次数后断开
  
重连策略:
  initial_delay: 1s                    # 首次重连延迟
  max_delay: 30s                       # 最大重连延迟
  backoff_multiplier: 2                # 退避系数
  max_retries: 10                      # 最大重试次数
  jitter: 0.3                          # 随机抖动因子
```

#### 断线恢复
```
1. 客户端记录最后收到的消息序列号 (lastSeq)
2. 重连时携带 lastSeq 参数
3. 服务端从 lastSeq 开始推送错过的消息
4. 消息保留时间：5分钟（超过则需客户端主动拉取）
```

#### 多端冲突处理
```
场景：PC端和移动端同时操作同一任务

处理策略：
1. 操作携带客户端时间戳和设备ID
2. 服务端采用「最后写入胜出 (LWW)」策略
3. 冲突时向其他端推送 sync_conflict 事件
4. 被覆盖端收到通知后刷新状态

示例事件：
{
    "event": "sync_conflict",
    "data": {
        "resourceType": "task",
        "resourceId": "tsk_123",
        "conflictField": "status",
        "yourValue": "paused",
        "currentValue": "running",
        "changedBy": "device_pc_001",
        "changedAt": "2024-10-15T10:00:00Z"
    }
}
```

---

## 4. 沙箱安全

### ADR-006: 用户代码沙箱安全策略

#### 背景
高级用户可编写自定义代码逻辑，需确保平台安全。

#### 决策
**采用「Docker容器隔离 + 严格资源限制 + 网络白名单」方案**

#### 资源限制

| 资源 | 限制值 | 说明 |
|------|--------|------|
| 内存 | 256MB | 硬限制，超出立即终止 |
| CPU | 0.5核 | CPU时间片限制 |
| 执行时间 | 30秒 | 超时强制终止 |
| 磁盘写入 | 50MB | 临时存储限制 |
| 进程数 | 10 | 防止fork炸弹 |
| 文件句柄 | 100 | 防止资源耗尽 |

#### 网络策略

```yaml
网络模式: 默认禁用

白名单开放（需用户申请审核）:
  - 常用API服务:
      - api.openai.com
      - api.anthropic.com
      - api.github.com
  - 用户自定义域名:
      - 需提交域名审核
      - 审核通过后加入白名单
      - 每个用户最多5个自定义域名

禁止访问:
  - 内网地址 (10.*, 172.16-31.*, 192.168.*)
  - localhost
  - 元数据服务 (169.254.169.254)
```

#### 代码审核规则

```python
# 禁止使用的模块/函数
BLOCKED_IMPORTS = [
    'os.system', 'subprocess', 'multiprocessing',
    'socket', 'ctypes', 'pickle', 'marshal',
    '__import__', 'eval', 'exec', 'compile'
]

# 静态分析检查
def code_review(code: str) -> ReviewResult:
    # 1. 语法检查
    # 2. 禁用模块检查
    # 3. 敏感API调用检查
    # 4. 无限循环检测（基于AST）
    pass
```

#### 运行时监控

```
1. 实时资源使用监控
2. 系统调用审计日志
3. 异常行为检测（如大量网络请求）
4. 自动终止 + 用户通知
```

---

## 5. 边界场景处理

### ADR-007: 员工工作中被解雇

#### 场景描述
CEO解雇一个正在执行任务的员工。

#### 决策
**禁止解雇 + 提供强制选项**

#### 处理流程
```
1. 检测员工状态
2. 如果 status == 'working':
   a. 默认返回错误，提示员工正在工作
   b. 提供 force=true 参数强制解雇
   
3. 强制解雇时：
   a. 当前执行的步骤标记为 failed
   b. 任务进入 error 状态
   c. 触发预警通知CEO
   d. 项管尝试自动分配其他员工（如有）
   
4. 员工解雇后：
   a. 技能卡自动卸载，归还技能库
   b. 历史任务记录归档（不删除）
   c. 员工数据标记为 deleted（软删除）
```

#### API响应示例
```json
// 拒绝解雇
{
    "code": 40901,
    "message": "Cannot dismiss employee while working. Use force=true to force dismiss.",
    "data": {
        "employeeId": "emp_001",
        "status": "working",
        "currentTask": {
            "taskId": "tsk_123",
            "taskName": "生成文案"
        }
    }
}
```

---

### ADR-008: 技能卡被下架时的处理

#### 场景描述
市场上的技能卡被创建者下架或被平台删除，已购买/装备的用户如何处理。

#### 决策
**采用「已购继续使用 + 版本快照」方案**

#### 处理规则

| 情况 | 处理方式 |
|------|----------|
| 用户已购买 | 继续可用，保留最后购买时的版本 |
| 已装备给员工 | 继续可用，不受影响 |
| 市场搜索 | 下架后不再出现 |
| 新用户购买 | 无法购买 |
| 创建者更新 | 不影响已购用户，除非用户主动更新 |

#### 数据模型补充
```sql
-- 在技能卡持有表增加版本快照
ALTER TABLE skill_card_ownerships ADD COLUMN snapshot JSONB;

-- snapshot 存储购买时的完整技能卡配置
-- 技能卡下架后，用户使用 snapshot 中的配置执行
```

---

### ADR-009: 工作流执行中修改模板

#### 场景描述
某个工作流模板正在被多个任务使用，此时创建者修改了模板。

#### 决策
**采用「版本隔离 + 运行时不受影响」方案**

#### 处理规则

```
1. 每次保存模板自动创建新版本
2. 任务创建时绑定特定版本号
3. 任务执行始终使用创建时的版本
4. 模板修改不影响正在运行的任务

版本管理：
- workflow_templates.version: 当前最新版本号
- workflow_template_versions: 历史版本表，存储完整配置快照
- tasks.workflow_version: 任务绑定的版本号
```

#### 用户体验

```
创建任务时：
- 默认使用最新版本
- 可选择历史版本（高级选项）

任务详情中：
- 显示所用工作流版本
- 如果有新版本，提示"有新版本可用"
```

---

### ADR-010: 外包任务取消规则

#### 场景描述
外包任务在不同阶段被CEO取消，如何处理资金和信用。

#### 决策
**采用「阶段性退款 + 信用影响」方案**

#### 取消规则

| 阶段 | CEO取消 | 退款比例 | CEO信用影响 | 服务商补偿 |
|------|---------|----------|-------------|------------|
| 发布中（无人接单） | 允许 | 100% | 无 | 无 |
| 竞标中 | 允许 | 100% | -2分 | 无 |
| 已接单未开始 | 允许 | 90% | -5分 | 10%作为违约金 |
| 进行中（<50%） | 需协商 | 50-80% | -10分 | 20-50%按比例 |
| 进行中（≥50%） | 需协商 | 0-50% | -15分 | 50-100%按比例 |
| 待验收 | 需说明理由 | 0% | -20分 | 100%（争议仲裁） |

#### 争议仲裁流程

```
1. 任一方发起争议
2. 平台冻结资金
3. 双方提交证据（聊天记录、交付物、需求描述）
4. 平台仲裁员48小时内裁决
5. 按裁决结果分配资金
6. 更新双方信用分
```

---

### ADR-011: 多端同时操作冲突

#### 场景描述
用户在PC和手机同时对同一资源进行操作。

#### 决策
**采用「乐观锁 + 实时通知」方案**

#### 实现机制

```typescript
// 资源更新时携带版本号
interface UpdateRequest {
    resourceId: string;
    version: number;      // 客户端持有的版本
    changes: object;
}

// 服务端处理
function handleUpdate(req: UpdateRequest): UpdateResult {
    const current = getResource(req.resourceId);
    
    if (current.version !== req.version) {
        // 版本冲突
        return {
            success: false,
            error: 'VERSION_CONFLICT',
            currentVersion: current.version,
            currentState: current.data,
            yourChanges: req.changes
        };
    }
    
    // 更新成功，版本号+1
    const newVersion = current.version + 1;
    saveResource(req.resourceId, req.changes, newVersion);
    
    // 通知其他端
    broadcastToOtherDevices(req.resourceId, {
        event: 'resource_updated',
        version: newVersion,
        changes: req.changes
    });
    
    return { success: true, newVersion };
}
```

#### 客户端处理

```typescript
// 收到冲突响应
function handleConflict(response: ConflictResponse) {
    // 1. 展示冲突提示
    showConflictDialog({
        message: '该内容已被其他设备修改',
        currentState: response.currentState,
        yourChanges: response.yourChanges,
        actions: [
            { label: '覆盖我的修改', action: 'accept_remote' },
            { label: '强制使用我的', action: 'force_local' },
            { label: '合并修改', action: 'merge' }  // 如果支持
        ]
    });
}
```

---

## 6. 性能与扩展

### ADR-012: 任务队列与调度策略

#### 背景
高并发场景下如何保证任务调度的公平性和效率。

#### 决策
**采用「优先级队列 + 公平调度」方案**

#### 队列设计

```
┌─────────────────────────────────────────────────────────────────┐
│                        任务队列架构                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │  高优先级队列   │  │  普通优先级队列  │  │  低优先级队列   │ │
│  │  (Priority 1-3) │  │  (Priority 4-7) │  │  (Priority 8-10)│ │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘ │
│           │                    │                    │           │
│           └────────────────────┼────────────────────┘           │
│                                │                                │
│                    ┌───────────▼───────────┐                    │
│                    │      调度器           │                    │
│                    │  (加权公平调度)        │                    │
│                    └───────────┬───────────┘                    │
│                                │                                │
│           ┌────────────────────┼────────────────────┐           │
│           ▼                    ▼                    ▼           │
│     ┌──────────┐         ┌──────────┐         ┌──────────┐     │
│     │ Worker 1 │         │ Worker 2 │         │ Worker N │     │
│     └──────────┘         └──────────┘         └──────────┘     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 调度权重

| 优先级 | 权重 | 说明 |
|--------|------|------|
| 1-3 (高) | 60% | 紧急任务，优先处理 |
| 4-7 (普通) | 30% | 常规任务 |
| 8-10 (低) | 10% | 后台任务，延迟容忍 |

#### 反饥饿机制

```
1. 任务在队列中每等待1分钟，优先级提升1级
2. 等待超过10分钟的任务强制提升到高优先级队列
3. 单用户任务数限制：同时执行不超过10个
```

---

### ADR-013: 数据库分片策略

#### 背景
随着用户增长，需要考虑数据库水平扩展。

#### 决策
**采用「按公司ID分片 + 读写分离」方案**

#### 分片策略

```
分片键: company_id

分片规则:
- 使用一致性哈希
- 初始4个分片，支持动态扩展
- 跨分片查询通过应用层聚合

数据分布:
- 用户表: 不分片（数据量可控）
- 公司表: 不分片
- 员工表: 按 company_id 分片
- 任务表: 按 company_id 分片
- 技能卡表: 不分片（共享资源）
- 任务步骤表: 按 task_id 所属 company_id 分片
```

#### 读写分离

```yaml
写操作: 主库
读操作:
  - 实时性要求高: 主库
  - 报表/统计: 从库
  - 搜索: Elasticsearch

从库延迟容忍:
  - 驾驶舱数据: 1秒
  - 历史记录: 5秒
  - 报表数据: 30秒
```

---

## 7. MVP范围细化

### ADR-014: MVP功能边界

#### 背景
需明确1.0版本的精确功能边界，避免范围蔓延。

#### 决策
**采用「核心闭环优先」方案**

#### MVP包含功能（必须）

```
┌─────────────────────────────────────────────────────────────────┐
│                     MVP 功能清单 (Must Have)                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  技能卡系统:                                                     │
│  ✅ 3个预置技能卡（热点分析、文案生成、配图生成）                  │
│  ✅ 技能卡浏览与详情查看                                          │
│  ✅ 技能卡测试功能                                                │
│  ❌ 自定义技能卡创建（移至2.0）                                   │
│  ❌ 技能卡市场交易（移至3.0）                                     │
│                                                                 │
│  员工系统:                                                       │
│  ✅ 5个预置员工模板                                               │
│  ✅ 员工招募（上限5名）                                           │
│  ✅ 技能卡装备/卸载                                               │
│  ✅ 员工状态显示（空闲/工作中）                                   │
│                                                                 │
│  工作流:                                                         │
│  ✅ 3个预置工作流模板                                             │
│  ✅ 选择模板创建任务                                              │
│  ✅ 任务监控（进度、状态）                                        │
│  ✅ 任务干预（暂停、取消、重试）                                   │
│  ❌ 可视化工作流设计器（移至2.0）                                  │
│  ❌ 条件分支/并行节点（移至2.0）                                   │
│                                                                 │
│  驾驶舱:                                                         │
│  ✅ 简化版KPI面板（任务数、成功率）                                │
│  ✅ 任务列表                                                      │
│  ✅ 基础活动流                                                    │
│  ❌ 完整仪表盘自定义（移至2.0）                                    │
│                                                                 │
│  秘书系统:                                                       │
│  ✅ 私人秘书基础交互（任务创建、状态查询）                         │
│  ❌ 业务秘书日报（移至2.0）                                       │
│  ❌ 生活秘书状态感知（移至2.0）                                    │
│                                                                 │
│  平台:                                                           │
│  ✅ Web端                                                         │
│  ❌ 移动端App（移至2.0）                                          │
│  ❌ 桌面端EXE（移至2.0）                                          │
│                                                                 │
│  用户系统:                                                       │
│  ✅ 注册/登录                                                     │
│  ✅ 免费版功能                                                    │
│  ❌ 付费订阅（移至2.0）                                           │
│  ❌ 团队协作（移至3.0）                                           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### MVP开发里程碑

| 阶段 | 时间 | 交付物 |
|------|------|--------|
| M1 | 第1-2月 | 基础框架、用户系统、数据库 |
| M2 | 第3-4月 | 技能卡系统、员工系统 |
| M3 | 第5-6月 | 工作流引擎、任务调度 |
| M4 | 第7-8月 | 驾驶舱、秘书、联调测试 |

#### MVP验收标准

```
1. 用户可注册登录，创建虚拟公司
2. 可招募至少3名员工，装备技能卡
3. 可使用预置工作流创建任务
4. 任务可成功执行并获得产出物
5. 任务成功率 ≥ 90%
6. 平均任务执行时间 ≤ 5分钟
7. 系统可用性 ≥ 99%
8. 页面加载时间 ≤ 2秒
```

---

## 8. 决策评审记录

| 决策编号 | 决策标题 | 状态 | 评审日期 | 评审人 |
|----------|----------|------|----------|--------|
| ADR-001 | AI模型接入方案 | 待评审 | - | - |
| ADR-002 | Token计费策略 | 待评审 | - | - |
| ADR-003 | 多租户隔离方案 | 待评审 | - | - |
| ADR-004 | 版本升级数据迁移 | 待评审 | - | - |
| ADR-005 | WebSocket连接管理 | 待评审 | - | - |
| ADR-006 | 沙箱安全策略 | 待评审 | - | - |
| ADR-007 | 员工解雇处理 | 待评审 | - | - |
| ADR-008 | 技能卡下架处理 | 待评审 | - | - |
| ADR-009 | 工作流版本管理 | 待评审 | - | - |
| ADR-010 | 外包取消规则 | 待评审 | - | - |
| ADR-011 | 多端冲突处理 | 待评审 | - | - |
| ADR-012 | 任务调度策略 | 待评审 | - | - |
| ADR-013 | 数据库分片策略 | 待评审 | - | - |
| ADR-014 | MVP功能边界 | 待评审 | - | - |

---

## 附录：待讨论事项

以下事项需要与团队进一步讨论后决策：

1. **支付渠道**：支持微信支付+支付宝，还是需要支持更多？
2. **数据合规**：是否需要支持数据导出（GDPR）？用户注销流程？
3. **灰度发布**：新功能灰度策略？按用户比例还是按地区？
4. **SLA承诺**：对付费用户的服务等级承诺？
5. **国际化**：1.0是否需要支持多语言？优先哪些语言？

---

*文档结束*
