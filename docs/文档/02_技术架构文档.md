# 《无限公司 Unlimited Corp.》技术架构文档

## 文档信息
| 项目 | 内容 |
|------|------|
| 产品名称 | 无限公司 (Unlimited Corp.) |
| 文档版本 | v1.0 |
| 文档类型 | 技术架构设计 |
| 创建日期 | 2024年10月 |

---

## 1. 架构概述

### 1.1 架构目标
- **高可用**：支持99.9%系统可用性
- **高性能**：万级并发用户，毫秒级响应
- **可扩展**：微服务架构，支持水平扩展
- **安全性**：多层安全防护，数据加密存储
- **多端支持**：Web、桌面端、移动端统一架构

### 1.2 技术选型总览

| 层级 | 技术选型 | 说明 |
|------|----------|------|
| 前端-Web | React 18 + TypeScript + Vite | 现代化SPA框架 |
| 前端-桌面 | Tauri 2.0 | 轻量级跨平台桌面框架 |
| 前端-移动 | React Native | 跨平台移动开发 |
| API网关 | Kong / APISIX | 流量管理、认证、限流 |
| 后端服务 | Go + Gin | 高性能微服务 |
| 工作流引擎 | Temporal | 分布式工作流编排 |
| 消息队列 | Apache Kafka | 事件驱动架构核心 |
| 缓存 | Redis Cluster | 高速缓存与状态存储 |
| 数据库 | PostgreSQL | 主数据存储 |
| 时序数据库 | TimescaleDB | 状态变更与指标存储 |
| 对象存储 | MinIO / S3 | 文件与产出物存储 |
| 搜索引擎 | Elasticsearch | 技能卡/市场搜索 |
| 容器编排 | Kubernetes | 服务部署与管理 |
| 监控 | Prometheus + Grafana | 系统监控与告警 |

---

## 2. 系统架构图

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              客户端层 (Client Layer)                          │
├─────────────────┬─────────────────┬─────────────────┬─────────────────────────┤
│   Web Browser   │   Desktop App   │   Mobile App    │   Third-party Clients   │
│   (React SPA)   │    (Tauri)      │ (React Native)  │      (Open API)         │
└────────┬────────┴────────┬────────┴────────┬────────┴───────────┬─────────────┘
         │                 │                 │                     │
         └─────────────────┴────────┬────────┴─────────────────────┘
                                    │ HTTPS/WSS
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              接入层 (Gateway Layer)                          │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────────┐  │
│  │   API网关    │  │   负载均衡   │  │    CDN      │  │   WebSocket网关  │  │
│  │  (Kong)      │  │  (Nginx)     │  │ (CloudFlare)│  │   (Socket.IO)    │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                             业务服务层 (Service Layer)                       │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐            │
│  │  用户服务   │ │  技能卡服务  │ │   员工服务  │ │  任务服务   │            │
│  │ User Svc    │ │ SkillCard   │ │ Employee    │ │ Task Svc    │            │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘            │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐            │
│  │  工作流服务  │ │   调度服务  │ │   项管服务  │ │  秘书服务   │            │
│  │ Workflow    │ │ Scheduler   │ │ ProjectMgr  │ │ Secretary   │            │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘            │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐            │
│  │   市场服务  │ │   交易服务  │ │  通知服务   │ │  外包服务   │            │
│  │ Market Svc  │ │ Payment Svc │ │ Notify Svc  │ │ Outsource   │            │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘            │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            核心引擎层 (Engine Layer)                         │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌──────────────────────┐  ┌──────────────────────┐  ┌────────────────────┐ │
│  │    工作流引擎        │  │    技能卡执行器       │  │   AI调用适配层    │ │
│  │   (Temporal)         │  │   (Skill Executor)   │  │  (LLM Gateway)    │ │
│  └──────────────────────┘  └──────────────────────┘  └────────────────────┘ │
│  ┌──────────────────────┐  ┌──────────────────────┐                         │
│  │    代码沙箱          │  │    事件中枢           │                         │
│  │   (Docker Sandbox)   │  │   (Event Hub)        │                         │
│  └──────────────────────┘  └──────────────────────┘                         │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                             数据层 (Data Layer)                              │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐ │
│  │ PostgreSQL │ │   Redis    │ │TimescaleDB │ │Elasticsearch│ │  MinIO    │ │
│  │  (主库)    │ │  (缓存)    │ │ (时序)     │ │  (搜索)    │ │ (存储)    │ │
│  └────────────┘ └────────────┘ └────────────┘ └────────────┘ └────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            外部集成层 (External)                             │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐ │
│  │  OpenAI    │ │ Claude API │ │  支付宝    │ │   微信     │ │  APNs/FCM  │ │
│  │   API      │ │            │ │  支付      │ │   支付     │ │   推送     │ │
│  └────────────┘ └────────────┘ └────────────┘ └────────────┘ └────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 事件驱动架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Kafka Event Hub (事件中枢)                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Topics:                                                                    │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐               │
│  │ task.created    │ │ task.completed  │ │ task.failed     │               │
│  └─────────────────┘ └─────────────────┘ └─────────────────┘               │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐               │
│  │ step.ready      │ │ step.assigned   │ │ step.completed  │               │
│  └─────────────────┘ └─────────────────┘ └─────────────────┘               │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐               │
│  │ employee.status │ │ user.state      │ │ alert.triggered │               │
│  └─────────────────┘ └─────────────────┘ └─────────────────┘               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
        │                       │                       │
        ▼                       ▼                       ▼
┌───────────────┐      ┌───────────────┐       ┌───────────────┐
│  工作流引擎   │      │   调度服务    │       │   通知服务    │
│  (Consumer)   │      │  (Consumer)   │       │  (Consumer)   │
└───────────────┘      └───────────────┘       └───────────────┘
```

---

## 3. 核心服务设计

### 3.1 服务清单

| 服务名称 | 职责 | 核心接口 | 依赖 |
|----------|------|----------|------|
| user-service | 用户认证、权限管理 | 注册/登录/权限校验 | PostgreSQL, Redis |
| skillcard-service | 技能卡CRUD、市场管理 | 技能卡管理/搜索/购买 | PostgreSQL, ES, MinIO |
| employee-service | 员工管理、状态维护 | 员工招募/装备/状态查询 | PostgreSQL, Redis |
| workflow-service | 工作流编排与执行 | 模板管理/实例创建/执行控制 | Temporal, PostgreSQL |
| scheduler-service | 任务调度与员工匹配 | 调度算法/队列管理 | Redis, Kafka |
| task-service | 任务全生命周期管理 | 任务CRUD/状态流转 | PostgreSQL, Kafka |
| skill-executor | 技能卡执行引擎 | 技能执行/结果回写 | Docker, LLM APIs |
| secretary-service | 秘书处交互逻辑 | 指令解析/报告生成/状态管理 | LLM APIs, TimescaleDB |
| project-manager | 项目监控与预警 | 监控/预警/自动协调 | TimescaleDB, Kafka |
| market-service | 市场交易管理 | 商品发布/订单管理 | PostgreSQL, Payment |
| payment-service | 支付与结算 | 支付/退款/结算 | Payment Gateway |
| notify-service | 多端通知推送 | 站内信/推送/邮件 | APNs, FCM, SMTP |
| sync-service | 多端状态同步 | 状态广播/增量同步 | Redis, WebSocket |

### 3.2 服务通信模式

```
┌─────────────────────────────────────────────────────────────────┐
│                        通信模式选择                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  同步通信 (gRPC)                     异步通信 (Kafka)           │
│  ├── 用户认证                        ├── 任务状态变更            │
│  ├── 技能卡查询                      ├── 员工状态更新            │
│  ├── 员工信息获取                    ├── 工作流步骤推进          │
│  └── 权限校验                        ├── 通知推送               │
│                                      └── 事件日志               │
│                                                                 │
│  实时通信 (WebSocket)                                           │
│  ├── 驾驶舱数据刷新                                             │
│  ├── 任务执行进度                                               │
│  ├── 秘书对话                                                   │
│  └── 多端状态同步                                               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. 数据模型设计

### 4.1 核心实体ER图

```
┌──────────────────┐       ┌──────────────────┐       ┌──────────────────┐
│      User        │       │    Company       │       │   Subscription   │
├──────────────────┤       ├──────────────────┤       ├──────────────────┤
│ id (PK)          │──1:1──│ id (PK)          │──1:1──│ id (PK)          │
│ email            │       │ user_id (FK)     │       │ company_id (FK)  │
│ password_hash    │       │ name             │       │ plan_type        │
│ phone            │       │ created_at       │       │ status           │
│ avatar_url       │       │ status           │       │ expires_at       │
│ created_at       │       └──────────────────┘       └──────────────────┘
└──────────────────┘              │
                                  │ 1:N
                                  ▼
┌──────────────────┐       ┌──────────────────┐       ┌──────────────────┐
│   SkillCard      │       │    Employee      │       │   SkillEquip     │
├──────────────────┤       ├──────────────────┤       ├──────────────────┤
│ id (PK)          │       │ id (PK)          │──1:1──│ id (PK)          │
│ name             │       │ company_id (FK)  │       │ employee_id (FK) │
│ description      │       │ template_id      │       │ skillcard_id (FK)│
│ category         │       │ name             │       │ equipped_at      │
│ input_schema     │       │ avatar_url       │       └──────────────────┘
│ output_schema    │       │ status           │              │
│ kernel_type      │       │ position_x       │              │
│ kernel_config    │       │ position_y       │              │
│ creator_id       │       │ created_at       │              │
│ price            │       └──────────────────┘              │
│ is_public        │              │ 1:N                      │
└──────────────────┘              ▼                          │
        │             ┌──────────────────┐                   │
        │             │   TaskAssignment │◄──────────────────┘
        │             ├──────────────────┤
        │             │ id (PK)          │
        │             │ task_step_id(FK) │
        │             │ employee_id (FK) │
        │             │ status           │
        │             │ started_at       │
        │             │ completed_at     │
        │             │ result_data      │
        │             └──────────────────┘
        │                     ▲
        │                     │ N:1
        ▼                     │
┌──────────────────┐   ┌──────────────────┐   ┌──────────────────┐
│ WorkflowTemplate │   │    TaskStep      │   │      Task        │
├──────────────────┤   ├──────────────────┤   ├──────────────────┤
│ id (PK)          │   │ id (PK)          │   │ id (PK)          │
│ name             │   │ task_id (FK)     │───│ company_id (FK)  │
│ description      │   │ workflow_node_id │   │ workflow_id (FK) │
│ nodes_config     │   │ sequence         │   │ name             │
│ edges_config     │   │ status           │   │ status           │
│ category         │   │ input_data       │   │ priority         │
│ is_public        │   │ output_data      │   │ started_at       │
│ creator_id       │   │ started_at       │   │ completed_at     │
└──────────────────┘   │ completed_at     │   │ created_at       │
                       └──────────────────┘   └──────────────────┘
```

### 4.2 核心表结构

#### 4.2.1 用户与公司

```sql
-- 用户表
CREATE TABLE users (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email           VARCHAR(255) UNIQUE NOT NULL,
    password_hash   VARCHAR(255) NOT NULL,
    phone           VARCHAR(20),
    nickname        VARCHAR(100),
    avatar_url      VARCHAR(500),
    status          VARCHAR(20) DEFAULT 'active', -- active, suspended, deleted
    created_at      TIMESTAMPTZ DEFAULT NOW(),
    updated_at      TIMESTAMPTZ DEFAULT NOW()
);

-- 公司表（每个用户一个虚拟公司）
CREATE TABLE companies (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id         UUID UNIQUE REFERENCES users(id),
    name            VARCHAR(100) NOT NULL,
    description     TEXT,
    office_layout   JSONB, -- 办公室布局配置
    status          VARCHAR(20) DEFAULT 'active',
    created_at      TIMESTAMPTZ DEFAULT NOW(),
    updated_at      TIMESTAMPTZ DEFAULT NOW()
);

-- 订阅表
CREATE TABLE subscriptions (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    company_id      UUID REFERENCES companies(id),
    plan_type       VARCHAR(20) NOT NULL, -- free, professional, team
    status          VARCHAR(20) DEFAULT 'active', -- active, expired, cancelled
    max_employees   INT NOT NULL,
    max_skillcards  INT NOT NULL,
    features        JSONB, -- 功能权限配置
    started_at      TIMESTAMPTZ NOT NULL,
    expires_at      TIMESTAMPTZ,
    created_at      TIMESTAMPTZ DEFAULT NOW()
);
```

#### 4.2.2 技能卡

```sql
-- 技能卡表
CREATE TABLE skill_cards (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name            VARCHAR(100) NOT NULL,
    description     TEXT,
    category        VARCHAR(50) NOT NULL, -- creative, collection, content, visual, optimize, publish, delivery
    input_schema    JSONB NOT NULL, -- JSON Schema定义输入
    output_schema   JSONB NOT NULL, -- JSON Schema定义输出
    kernel_type     VARCHAR(20) NOT NULL, -- ai_model, code_logic
    kernel_config   JSONB NOT NULL, -- 内核配置（模型ID/提示词/代码）
    creator_id      UUID REFERENCES users(id),
    is_public       BOOLEAN DEFAULT FALSE,
    price           DECIMAL(10,2) DEFAULT 0,
    price_type      VARCHAR(20) DEFAULT 'one_time', -- one_time, subscription
    status          VARCHAR(20) DEFAULT 'draft', -- draft, published, deprecated
    version         INT DEFAULT 1,
    icon_url        VARCHAR(500),
    tags            VARCHAR(100)[],
    created_at      TIMESTAMPTZ DEFAULT NOW(),
    updated_at      TIMESTAMPTZ DEFAULT NOW()
);

-- 技能卡持有表
CREATE TABLE skill_card_ownerships (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    company_id      UUID REFERENCES companies(id),
    skill_card_id   UUID REFERENCES skill_cards(id),
    acquired_type   VARCHAR(20) NOT NULL, -- purchased, subscribed, created
    acquired_at     TIMESTAMPTZ DEFAULT NOW(),
    expires_at      TIMESTAMPTZ, -- 订阅类型的过期时间
    UNIQUE(company_id, skill_card_id)
);
```

#### 4.2.3 员工

```sql
-- 员工模板表
CREATE TABLE employee_templates (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name            VARCHAR(100) NOT NULL,
    avatar_url      VARCHAR(500),
    personality     JSONB, -- 性格特征
    introduction    TEXT,
    rarity          VARCHAR(20) DEFAULT 'common', -- common, rare, epic
    created_at      TIMESTAMPTZ DEFAULT NOW()
);

-- 员工实例表
CREATE TABLE employees (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    company_id      UUID REFERENCES companies(id),
    template_id     UUID REFERENCES employee_templates(id),
    name            VARCHAR(100) NOT NULL,
    avatar_url      VARCHAR(500),
    status          VARCHAR(20) DEFAULT 'idle', -- idle, working
    position_x      INT DEFAULT 0, -- 办公室位置
    position_y      INT DEFAULT 0,
    performance     JSONB, -- 绩效数据
    created_at      TIMESTAMPTZ DEFAULT NOW(),
    updated_at      TIMESTAMPTZ DEFAULT NOW()
);

-- 技能装备表
CREATE TABLE skill_equips (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    employee_id     UUID UNIQUE REFERENCES employees(id), -- 一对一
    skill_card_id   UUID REFERENCES skill_cards(id),
    equipped_at     TIMESTAMPTZ DEFAULT NOW()
);
```

#### 4.2.4 工作流与任务

```sql
-- 工作流模板表
CREATE TABLE workflow_templates (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name            VARCHAR(100) NOT NULL,
    description     TEXT,
    category        VARCHAR(50),
    nodes           JSONB NOT NULL, -- 节点配置
    edges           JSONB NOT NULL, -- 连线配置
    estimated_time  INT, -- 预估耗时（秒）
    creator_id      UUID REFERENCES users(id),
    is_public       BOOLEAN DEFAULT FALSE,
    usage_count     INT DEFAULT 0,
    version         INT DEFAULT 1,
    created_at      TIMESTAMPTZ DEFAULT NOW(),
    updated_at      TIMESTAMPTZ DEFAULT NOW()
);

-- 任务表
CREATE TABLE tasks (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    company_id      UUID REFERENCES companies(id),
    workflow_id     UUID REFERENCES workflow_templates(id),
    name            VARCHAR(200) NOT NULL,
    status          VARCHAR(20) DEFAULT 'pending', -- pending, running, paused, completed, failed, cancelled
    priority        INT DEFAULT 5, -- 1-10
    input_params    JSONB, -- 起始参数
    output_result   JSONB, -- 最终产出
    progress        INT DEFAULT 0, -- 0-100
    started_at      TIMESTAMPTZ,
    completed_at    TIMESTAMPTZ,
    scheduled_at    TIMESTAMPTZ, -- 计划执行时间
    created_at      TIMESTAMPTZ DEFAULT NOW(),
    updated_at      TIMESTAMPTZ DEFAULT NOW()
);

-- 任务步骤表
CREATE TABLE task_steps (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    task_id         UUID REFERENCES tasks(id),
    node_id         VARCHAR(100) NOT NULL, -- 对应workflow节点ID
    skill_card_id   UUID REFERENCES skill_cards(id),
    sequence        INT NOT NULL,
    status          VARCHAR(20) DEFAULT 'pending', -- pending, assigned, running, completed, failed
    input_data      JSONB,
    output_data     JSONB,
    retry_count     INT DEFAULT 0,
    error_message   TEXT,
    started_at      TIMESTAMPTZ,
    completed_at    TIMESTAMPTZ,
    created_at      TIMESTAMPTZ DEFAULT NOW()
);

-- 任务分配表
CREATE TABLE task_assignments (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    task_step_id    UUID REFERENCES task_steps(id),
    employee_id     UUID REFERENCES employees(id),
    status          VARCHAR(20) DEFAULT 'assigned', -- assigned, executing, completed, failed
    assigned_at     TIMESTAMPTZ DEFAULT NOW(),
    started_at      TIMESTAMPTZ,
    completed_at    TIMESTAMPTZ,
    execution_log   JSONB
);
```

---

## 5. API设计规范

### 5.1 API设计原则

- RESTful风格，资源导向
- 统一响应格式
- 版本控制（URL前缀 /api/v1）
- JWT认证
- 请求限流

### 5.2 统一响应格式

```json
// 成功响应
{
    "code": 0,
    "message": "success",
    "data": { ... },
    "timestamp": 1699200000000
}

// 错误响应
{
    "code": 40001,
    "message": "Invalid parameter: email format incorrect",
    "data": null,
    "timestamp": 1699200000000
}

// 分页响应
{
    "code": 0,
    "message": "success",
    "data": {
        "items": [...],
        "pagination": {
            "page": 1,
            "page_size": 20,
            "total": 100,
            "total_pages": 5
        }
    },
    "timestamp": 1699200000000
}
```

### 5.3 核心API清单

#### 5.3.1 用户认证

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | /api/v1/auth/register | 用户注册 |
| POST | /api/v1/auth/login | 用户登录 |
| POST | /api/v1/auth/logout | 退出登录 |
| POST | /api/v1/auth/refresh | 刷新Token |
| GET | /api/v1/users/me | 获取当前用户信息 |

#### 5.3.2 技能卡

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/v1/skillcards | 获取技能卡列表 |
| GET | /api/v1/skillcards/:id | 获取技能卡详情 |
| POST | /api/v1/skillcards | 创建技能卡 |
| PUT | /api/v1/skillcards/:id | 更新技能卡 |
| DELETE | /api/v1/skillcards/:id | 删除技能卡 |
| POST | /api/v1/skillcards/:id/test | 测试技能卡 |
| GET | /api/v1/market/skillcards | 市场技能卡搜索 |
| POST | /api/v1/market/skillcards/:id/purchase | 购买技能卡 |

#### 5.3.3 员工

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/v1/employees | 获取员工列表 |
| GET | /api/v1/employees/:id | 获取员工详情 |
| POST | /api/v1/employees | 招募员工 |
| DELETE | /api/v1/employees/:id | 解雇员工 |
| PUT | /api/v1/employees/:id/position | 更新员工位置 |
| POST | /api/v1/employees/:id/equip | 装备技能卡 |
| DELETE | /api/v1/employees/:id/equip | 卸载技能卡 |
| GET | /api/v1/talent-market | 获取人才市场 |

#### 5.3.4 工作流与任务

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/v1/workflows | 获取工作流模板列表 |
| GET | /api/v1/workflows/:id | 获取工作流详情 |
| POST | /api/v1/workflows | 创建工作流 |
| PUT | /api/v1/workflows/:id | 更新工作流 |
| GET | /api/v1/tasks | 获取任务列表 |
| POST | /api/v1/tasks | 创建并发布任务 |
| GET | /api/v1/tasks/:id | 获取任务详情 |
| POST | /api/v1/tasks/:id/pause | 暂停任务 |
| POST | /api/v1/tasks/:id/resume | 恢复任务 |
| POST | /api/v1/tasks/:id/cancel | 取消任务 |
| POST | /api/v1/tasks/:id/retry | 重试任务 |

#### 5.3.5 驾驶舱

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/v1/dashboard/overview | 获取仪表盘概览 |
| GET | /api/v1/dashboard/kpis | 获取KPI数据 |
| GET | /api/v1/dashboard/alerts | 获取预警列表 |
| GET | /api/v1/dashboard/activities | 获取活动流 |

#### 5.3.6 秘书

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | /api/v1/secretary/command | 发送指令 |
| GET | /api/v1/secretary/reports/daily | 获取每日简报 |
| GET | /api/v1/secretary/reports/weekly | 获取周报 |
| PUT | /api/v1/secretary/user-state | 更新用户状态 |
| GET | /api/v1/secretary/conversations | 获取对话历史 |

### 5.4 WebSocket事件

```typescript
// 客户端订阅
interface SubscribeMessage {
    action: 'subscribe';
    channels: string[]; // ['task.{taskId}', 'employee.status', 'dashboard']
}

// 服务端推送
interface PushMessage {
    channel: string;
    event: string;
    data: any;
    timestamp: number;
}

// 事件类型
type Events = 
    | 'task.status_changed'
    | 'task.step_completed'
    | 'task.progress_updated'
    | 'employee.status_changed'
    | 'alert.triggered'
    | 'secretary.message'
    | 'sync.state_updated';
```

---

## 6. 安全设计

### 6.1 认证与授权

```
┌─────────────────────────────────────────────────────────────────┐
│                        认证流程                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐     │
│  │  登录   │───►│ 验证凭证 │───►│ 生成JWT │───►│ 返回Token│     │
│  └─────────┘    └─────────┘    └─────────┘    └─────────┘     │
│                                                                 │
│  JWT结构:                                                       │
│  {                                                              │
│    "header": { "alg": "RS256", "typ": "JWT" },                 │
│    "payload": {                                                 │
│      "sub": "user_id",                                         │
│      "company_id": "xxx",                                      │
│      "plan": "professional",                                   │
│      "exp": 1699999999,                                        │
│      "iat": 1699900000                                         │
│    }                                                            │
│  }                                                              │
│                                                                 │
│  Token刷新: Access Token 2h有效, Refresh Token 7d有效           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 6.2 权限模型 (RBAC)

| 角色 | 权限范围 |
|------|----------|
| owner | 公司所有资源的完全控制权 |
| admin | 除财务外的管理权限（团队版） |
| member | 任务执行与查看（团队版） |
| viewer | 只读权限（团队版） |

### 6.3 数据安全

- 传输加密：TLS 1.3
- 存储加密：AES-256（敏感字段）
- 密码存储：bcrypt (cost=12)
- API密钥：用户可生成/撤销，权限可配置

### 6.4 代码沙箱安全

```yaml
# Docker沙箱配置
resources:
  limits:
    memory: 256Mi
    cpu: 0.5
  requests:
    memory: 128Mi
    cpu: 0.1

security:
  network: none  # 禁用网络（除非显式开放）
  read_only_root: true
  no_new_privileges: true
  timeout: 30s  # 执行超时
```

---

## 7. 部署架构

### 7.1 Kubernetes部署

```yaml
# 服务部署示例
apiVersion: apps/v1
kind: Deployment
metadata:
  name: workflow-service
spec:
  replicas: 3
  selector:
    matchLabels:
      app: workflow-service
  template:
    spec:
      containers:
      - name: workflow-service
        image: unlimited-corp/workflow-service:latest
        ports:
        - containerPort: 8080
        resources:
          limits:
            memory: "512Mi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
```

### 7.2 环境规划

| 环境 | 用途 | 配置 |
|------|------|------|
| dev | 开发测试 | 单实例，共享资源 |
| staging | 预发布验证 | 生产配置缩小版 |
| production | 正式环境 | 高可用，多副本 |

---

## 8. 监控与运维

### 8.1 监控指标

| 类别 | 指标 | 告警阈值 |
|------|------|----------|
| 系统 | CPU使用率 | > 80% |
| 系统 | 内存使用率 | > 85% |
| 服务 | API响应时间P95 | > 500ms |
| 服务 | 错误率 | > 1% |
| 业务 | 任务失败率 | > 5% |
| 业务 | 调度延迟 | > 2s |

### 8.2 日志规范

```json
{
    "timestamp": "2024-10-01T12:00:00.000Z",
    "level": "INFO",
    "service": "workflow-service",
    "trace_id": "abc123",
    "span_id": "def456",
    "user_id": "user-xxx",
    "company_id": "company-xxx",
    "message": "Task created successfully",
    "context": {
        "task_id": "task-xxx",
        "workflow_id": "workflow-xxx"
    }
}
```

---

## 附录：技术决策记录

### ADR-001: 选择Temporal作为工作流引擎

**背景**：需要可靠的分布式工作流编排

**决策**：使用Temporal而非自研

**理由**：
- 原生支持长时间运行的工作流
- 内置重试、补偿、版本管理
- 可视化监控面板
- 社区活跃，文档完善

### ADR-002: 选择Tauri而非Electron

**背景**：需要开发跨平台桌面应用

**决策**：使用Tauri 2.0

**理由**：
- 安装包体积小（~5MB vs ~150MB）
- 内存占用低
- 使用系统WebView，更原生
- Rust后端，性能更好
