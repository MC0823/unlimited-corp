# 《无限公司》技术栈与环境配置

## 文档信息
| 项目 | 内容 |
|------|------|
| 创建日期 | 2024年12月 |
| 适用阶段 | 全部开发阶段 |

---

## 1. 开发环境要求

### 1.1 操作系统支持
- Windows 10/11 (推荐WSL2)
- macOS 12+
- Ubuntu 20.04+

### 1.2 必装软件

| 软件 | 版本要求 | 用途 | 安装命令/链接 |
|------|----------|------|---------------|
| Git | 2.30+ | 版本控制 | https://git-scm.com |
| Go | 1.21+ | 后端开发 | https://go.dev/dl |
| Node.js | 18 LTS+ | 前端开发 | https://nodejs.org |
| pnpm | 8.0+ | 包管理 | `npm install -g pnpm` |
| Docker | 24+ | 容器运行 | https://docker.com |
| Docker Compose | 2.20+ | 容器编排 | Docker Desktop自带 |
| VS Code | Latest | 代码编辑 | https://code.visualstudio.com |

### 1.3 推荐VS Code插件

```json
{
  "recommendations": [
    "golang.go",
    "ms-vscode.vscode-typescript-next",
    "dbaeumer.vscode-eslint",
    "esbenp.prettier-vscode",
    "bradlc.vscode-tailwindcss",
    "prisma.prisma",
    "ms-azuretools.vscode-docker",
    "humao.rest-client",
    "streetsidesoftware.code-spell-checker"
  ]
}
```

---

## 2. 技术栈详细配置

### 2.1 后端技术栈

#### Go项目结构
```
backend/
├── cmd/                          # 应用入口
│   ├── gateway/                  # API网关服务
│   ├── user-service/             # 用户服务
│   ├── skillcard-service/        # 技能卡服务
│   ├── employee-service/         # 员工服务
│   ├── workflow-service/         # 工作流服务
│   ├── task-service/             # 任务服务
│   ├── scheduler-service/        # 调度服务
│   ├── skill-executor/           # 技能执行器
│   └── secretary-service/        # 秘书服务
├── internal/                     # 内部包
│   ├── domain/                   # 领域模型
│   ├── repository/               # 数据访问层
│   ├── service/                  # 业务逻辑层
│   ├── handler/                  # HTTP处理层
│   ├── middleware/               # 中间件
│   └── pkg/                      # 工具包
├── pkg/                          # 公共包
│   ├── config/                   # 配置管理
│   ├── logger/                   # 日志
│   ├── database/                 # 数据库连接
│   ├── cache/                    # 缓存
│   ├── mq/                       # 消息队列
│   └── ai/                       # AI调用封装
├── migrations/                   # 数据库迁移
├── configs/                      # 配置文件
├── scripts/                      # 脚本
├── go.mod
├── go.sum
└── Makefile
```

#### 核心依赖
```go
// go.mod 核心依赖
module github.com/unlimited-corp/backend

go 1.21

require (
    github.com/gin-gonic/gin v1.9.1
    github.com/go-playground/validator/v10 v10.15.5
    github.com/golang-jwt/jwt/v5 v5.0.0
    github.com/jackc/pgx/v5 v5.4.3
    github.com/redis/go-redis/v9 v9.2.1
    github.com/segmentio/kafka-go v0.4.44
    go.temporal.io/sdk v1.25.1
    github.com/sashabaranov/go-openai v1.17.9
    go.uber.org/zap v1.26.0
    github.com/spf13/viper v1.17.0
    github.com/google/uuid v1.4.0
)
```

### 2.2 前端技术栈

#### 前端项目结构
```
frontend/
├── public/                       # 静态资源
├── src/
│   ├── api/                      # API请求封装
│   ├── assets/                   # 资源文件
│   ├── components/               # 通用组件
│   │   ├── ui/                   # 基础UI组件
│   │   ├── layout/               # 布局组件
│   │   └── business/             # 业务组件
│   ├── hooks/                    # 自定义Hooks
│   ├── pages/                    # 页面组件
│   │   ├── dashboard/            # 驾驶舱
│   │   ├── tasks/                # 任务中心
│   │   ├── employees/            # 员工管理
│   │   ├── skillcards/           # 技能卡
│   │   ├── workflows/            # 工作流
│   │   └── secretary/            # 秘书
│   ├── stores/                   # 状态管理
│   ├── styles/                   # 全局样式
│   ├── types/                    # TypeScript类型
│   ├── utils/                    # 工具函数
│   ├── App.tsx
│   ├── main.tsx
│   └── vite-env.d.ts
├── index.html
├── package.json
├── pnpm-lock.yaml
├── tsconfig.json
├── tailwind.config.js
├── vite.config.ts
└── .eslintrc.cjs
```

#### 核心依赖
```json
{
  "dependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "react-router-dom": "^6.18.0",
    "zustand": "^4.4.6",
    "axios": "^1.6.0",
    "antd": "^5.11.0",
    "@tanstack/react-query": "^5.8.0",
    "dayjs": "^1.11.10",
    "socket.io-client": "^4.7.2",
    "react-flow-renderer": "^10.3.17",
    "framer-motion": "^10.16.4"
  },
  "devDependencies": {
    "@types/react": "^18.2.37",
    "@types/react-dom": "^18.2.15",
    "@vitejs/plugin-react": "^4.1.1",
    "autoprefixer": "^10.4.16",
    "eslint": "^8.53.0",
    "postcss": "^8.4.31",
    "prettier": "^3.1.0",
    "tailwindcss": "^3.3.5",
    "typescript": "^5.2.2",
    "vite": "^5.0.0"
  }
}
```

---

## 3. 基础设施配置

### 3.1 Docker Compose编排

```yaml
# docker-compose.yml
version: '3.8'

services:
  # PostgreSQL 数据库
  postgres:
    image: postgres:15-alpine
    container_name: uc-postgres
    environment:
      POSTGRES_USER: unlimited
      POSTGRES_PASSWORD: unlimited123
      POSTGRES_DB: unlimited_corp
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./migrations/init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U unlimited"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis 缓存
  redis:
    image: redis:7-alpine
    container_name: uc-redis
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data

  # Kafka 消息队列
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: uc-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
    volumes:
      - zookeeper_data:/var/lib/zookeeper/data

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: uc-kafka
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    volumes:
      - kafka_data:/var/lib/kafka/data

  # MinIO 对象存储
  minio:
    image: minio/minio:latest
    container_name: uc-minio
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: unlimited
      MINIO_ROOT_PASSWORD: unlimited123
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data

  # Temporal 工作流引擎
  temporal:
    image: temporalio/auto-setup:1.22
    container_name: uc-temporal
    depends_on:
      - postgres
    ports:
      - "7233:7233"
    environment:
      - DB=postgresql
      - DB_PORT=5432
      - POSTGRES_USER=unlimited
      - POSTGRES_PWD=unlimited123
      - POSTGRES_SEEDS=postgres

  temporal-ui:
    image: temporalio/ui:2.21.0
    container_name: uc-temporal-ui
    depends_on:
      - temporal
    ports:
      - "8080:8080"
    environment:
      - TEMPORAL_ADDRESS=temporal:7233
      - TEMPORAL_CORS_ORIGINS=http://localhost:3000

  # Elasticsearch (可选，MVP阶段可用PostgreSQL全文搜索替代)
  # elasticsearch:
  #   image: elasticsearch:8.11.0
  #   container_name: uc-elasticsearch
  #   ports:
  #     - "9200:9200"
  #   environment:
  #     - discovery.type=single-node
  #     - xpack.security.enabled=false

volumes:
  postgres_data:
  redis_data:
  zookeeper_data:
  kafka_data:
  minio_data:
```

### 3.2 环境变量配置

```bash
# .env.example

# 应用配置
APP_ENV=development
APP_PORT=8000
APP_SECRET=your-secret-key-change-in-production

# 数据库配置
DB_HOST=localhost
DB_PORT=5432
DB_USER=unlimited
DB_PASSWORD=unlimited123
DB_NAME=unlimited_corp
DB_SSL_MODE=disable

# Redis配置
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=

# Kafka配置
KAFKA_BROKERS=localhost:9092

# MinIO配置
MINIO_ENDPOINT=localhost:9000
MINIO_ACCESS_KEY=unlimited
MINIO_SECRET_KEY=unlimited123
MINIO_BUCKET=unlimited-corp

# Temporal配置
TEMPORAL_HOST=localhost:7233
TEMPORAL_NAMESPACE=default

# AI配置
OPENAI_API_KEY=sk-your-openai-api-key
OPENAI_BASE_URL=https://api.openai.com/v1
CLAUDE_API_KEY=your-claude-api-key

# JWT配置
JWT_SECRET=your-jwt-secret-key
JWT_EXPIRE_HOURS=2
JWT_REFRESH_DAYS=7
```

---

## 4. 数据库初始化

### 4.1 初始化脚本

```sql
-- migrations/init.sql

-- 创建扩展
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pg_trgm";

-- 用户表
CREATE TABLE users (
    id              UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    email           VARCHAR(255) UNIQUE NOT NULL,
    password_hash   VARCHAR(255) NOT NULL,
    nickname        VARCHAR(100),
    avatar_url      VARCHAR(500),
    status          VARCHAR(20) DEFAULT 'active',
    created_at      TIMESTAMPTZ DEFAULT NOW(),
    updated_at      TIMESTAMPTZ DEFAULT NOW()
);

-- 公司表
CREATE TABLE companies (
    id              UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id         UUID UNIQUE REFERENCES users(id) ON DELETE CASCADE,
    name            VARCHAR(100) NOT NULL,
    description     TEXT,
    office_layout   JSONB DEFAULT '{}',
    status          VARCHAR(20) DEFAULT 'active',
    created_at      TIMESTAMPTZ DEFAULT NOW(),
    updated_at      TIMESTAMPTZ DEFAULT NOW()
);

-- 订阅表
CREATE TABLE subscriptions (
    id              UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    company_id      UUID REFERENCES companies(id) ON DELETE CASCADE,
    plan_type       VARCHAR(20) NOT NULL DEFAULT 'free',
    max_employees   INT NOT NULL DEFAULT 5,
    max_skillcards  INT NOT NULL DEFAULT 10,
    features        JSONB DEFAULT '{}',
    started_at      TIMESTAMPTZ DEFAULT NOW(),
    expires_at      TIMESTAMPTZ,
    created_at      TIMESTAMPTZ DEFAULT NOW()
);

-- 技能卡表
CREATE TABLE skill_cards (
    id              UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name            VARCHAR(100) NOT NULL,
    description     TEXT,
    category        VARCHAR(50) NOT NULL,
    input_schema    JSONB NOT NULL,
    output_schema   JSONB NOT NULL,
    kernel_type     VARCHAR(20) NOT NULL,
    kernel_config   JSONB NOT NULL,
    creator_id      UUID REFERENCES users(id),
    is_public       BOOLEAN DEFAULT FALSE,
    is_system       BOOLEAN DEFAULT FALSE,
    price           DECIMAL(10,2) DEFAULT 0,
    price_type      VARCHAR(20) DEFAULT 'free',
    status          VARCHAR(20) DEFAULT 'draft',
    version         INT DEFAULT 1,
    icon_url        VARCHAR(500),
    tags            VARCHAR(100)[],
    usage_count     INT DEFAULT 0,
    rating          DECIMAL(2,1) DEFAULT 0,
    rating_count    INT DEFAULT 0,
    created_at      TIMESTAMPTZ DEFAULT NOW(),
    updated_at      TIMESTAMPTZ DEFAULT NOW()
);

-- 员工模板表
CREATE TABLE employee_templates (
    id              UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name            VARCHAR(100) NOT NULL,
    avatar_url      VARCHAR(500),
    personality     JSONB,
    introduction    TEXT,
    rarity          VARCHAR(20) DEFAULT 'common',
    recommended_skills VARCHAR(50)[],
    created_at      TIMESTAMPTZ DEFAULT NOW()
);

-- 员工实例表
CREATE TABLE employees (
    id              UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    company_id      UUID REFERENCES companies(id) ON DELETE CASCADE,
    template_id     UUID REFERENCES employee_templates(id),
    name            VARCHAR(100) NOT NULL,
    avatar_url      VARCHAR(500),
    status          VARCHAR(20) DEFAULT 'idle',
    position_x      INT DEFAULT 0,
    position_y      INT DEFAULT 0,
    performance     JSONB DEFAULT '{}',
    created_at      TIMESTAMPTZ DEFAULT NOW(),
    updated_at      TIMESTAMPTZ DEFAULT NOW()
);

-- 技能装备表
CREATE TABLE skill_equips (
    id              UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    employee_id     UUID UNIQUE REFERENCES employees(id) ON DELETE CASCADE,
    skill_card_id   UUID REFERENCES skill_cards(id),
    equipped_at     TIMESTAMPTZ DEFAULT NOW()
);

-- 工作流模板表
CREATE TABLE workflow_templates (
    id              UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name            VARCHAR(100) NOT NULL,
    description     TEXT,
    category        VARCHAR(50),
    nodes           JSONB NOT NULL,
    edges           JSONB NOT NULL,
    input_schema    JSONB,
    estimated_time  INT,
    creator_id      UUID REFERENCES users(id),
    is_public       BOOLEAN DEFAULT FALSE,
    is_system       BOOLEAN DEFAULT FALSE,
    usage_count     INT DEFAULT 0,
    success_rate    DECIMAL(3,2) DEFAULT 0,
    version         INT DEFAULT 1,
    thumbnail       VARCHAR(500),
    created_at      TIMESTAMPTZ DEFAULT NOW(),
    updated_at      TIMESTAMPTZ DEFAULT NOW()
);

-- 任务表
CREATE TABLE tasks (
    id              UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    company_id      UUID REFERENCES companies(id) ON DELETE CASCADE,
    workflow_id     UUID REFERENCES workflow_templates(id),
    workflow_version INT DEFAULT 1,
    name            VARCHAR(200) NOT NULL,
    status          VARCHAR(20) DEFAULT 'pending',
    priority        INT DEFAULT 5,
    input_params    JSONB,
    output_result   JSONB,
    progress        INT DEFAULT 0,
    error_message   TEXT,
    started_at      TIMESTAMPTZ,
    completed_at    TIMESTAMPTZ,
    scheduled_at    TIMESTAMPTZ,
    created_at      TIMESTAMPTZ DEFAULT NOW(),
    updated_at      TIMESTAMPTZ DEFAULT NOW()
);

-- 任务步骤表
CREATE TABLE task_steps (
    id              UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    task_id         UUID REFERENCES tasks(id) ON DELETE CASCADE,
    node_id         VARCHAR(100) NOT NULL,
    skill_card_id   UUID REFERENCES skill_cards(id),
    sequence        INT NOT NULL,
    status          VARCHAR(20) DEFAULT 'pending',
    input_data      JSONB,
    output_data     JSONB,
    retry_count     INT DEFAULT 0,
    error_message   TEXT,
    started_at      TIMESTAMPTZ,
    completed_at    TIMESTAMPTZ,
    created_at      TIMESTAMPTZ DEFAULT NOW()
);

-- 任务分配表
CREATE TABLE task_assignments (
    id              UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    task_step_id    UUID REFERENCES task_steps(id) ON DELETE CASCADE,
    employee_id     UUID REFERENCES employees(id),
    status          VARCHAR(20) DEFAULT 'assigned',
    assigned_at     TIMESTAMPTZ DEFAULT NOW(),
    started_at      TIMESTAMPTZ,
    completed_at    TIMESTAMPTZ,
    execution_log   JSONB
);

-- 创建索引
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_companies_user_id ON companies(user_id);
CREATE INDEX idx_employees_company_id ON employees(company_id);
CREATE INDEX idx_employees_status ON employees(status);
CREATE INDEX idx_skill_cards_category ON skill_cards(category);
CREATE INDEX idx_skill_cards_status ON skill_cards(status);
CREATE INDEX idx_tasks_company_id ON tasks(company_id);
CREATE INDEX idx_tasks_status ON tasks(status);
CREATE INDEX idx_task_steps_task_id ON task_steps(task_id);
```

---

## 5. 启动指南

### 5.1 首次启动

```bash
# 1. 克隆仓库
git clone https://github.com/your-org/unlimited-corp.git
cd unlimited-corp

# 2. 复制环境配置
cp .env.example .env
# 编辑.env，填入必要的配置（特别是AI API Key）

# 3. 启动基础设施
docker-compose up -d

# 4. 等待服务就绪（约30秒）
docker-compose ps

# 5. 启动后端服务（开发模式）
cd backend
go mod download
make dev

# 6. 启动前端（另一个终端）
cd frontend
pnpm install
pnpm dev
```

### 5.2 常用命令

```bash
# 后端命令
make dev          # 开发模式运行
make build        # 构建
make test         # 运行测试
make lint         # 代码检查
make migrate-up   # 执行迁移
make migrate-down # 回滚迁移

# 前端命令
pnpm dev          # 开发模式
pnpm build        # 生产构建
pnpm preview      # 预览构建结果
pnpm lint         # ESLint检查
pnpm format       # Prettier格式化

# Docker命令
docker-compose up -d          # 后台启动
docker-compose down           # 停止
docker-compose logs -f kafka  # 查看日志
docker-compose restart redis  # 重启服务
```

---

## 6. 开发规范速查

### 6.1 Git分支策略

```
main          ← 生产分支，受保护
  └── develop ← 开发主分支
        ├── feature/xxx  ← 功能分支
        ├── bugfix/xxx   ← 修复分支
        └── hotfix/xxx   ← 紧急修复
```

### 6.2 提交信息格式

```
<type>(<scope>): <subject>

type: feat|fix|docs|style|refactor|test|chore
scope: user|skillcard|employee|workflow|task|ui
```

示例：
```
feat(employee): 实现员工招募API
fix(task): 修复任务状态更新bug
docs(api): 更新API文档
```

---

*文档结束*
